<html>
    <head>
        <title>a2b simulator</title>
        <link rel="stylesheet" href="{{ url_for('.static', filename='style.css') }}">
    </head>
    <body>
        <div class="centered">
            <div class="pod">
                <h1>a2b simulator</h1>
                <p>Have an experience of what a2b is like without having to move</p>
            </div>
            <div class="columns">
                <div class="pod pod-border-blue">
                    <h4>Left Hand Side</h4>
                    <p>Current pattern: {{ lhs }}</p>
                    <form method="POST" action="{{ url_for('lhs_control') }}">
                        <select id="lhs" name="pattern">
                            <option value="none">None</option>
                            <option value="very_near">Very Near</option>
                            <option value="near">Near</option>
                            <option value="far">Far</option>
                            <option value="very_far">Very Far</option>
                        </select>
                        <input type="submit" value="Submit">
                    </form>
                </div>
                <div class="pod pod-border-red">
                    <h4>Right Hand Side</h4>
                    <p>Current pattern: {{ rhs }}</p>
                    <form method="POST" action="{{ url_for('rhs_control') }}">
                        <select id="rhs" name="pattern">
                            <option value="none">None</option>
                            <option value="very_near">Very Near</option>
                            <option value="near">Near</option>
                            <option value="far">Far</option>
                            <option value="very_far">Very Far</option>
                        </select>
                        <input type="submit" value="Submit">
                    </form>
                </div>
            </div>
            <div class="pod">
                <h4>Video Demonstration</h4>
                <br>
                <p id="simulation-status">Current Time: None</p>
                <button id="simulation-trigger">Begin</button>
                <br>
                <video width="560" height="405" id="visual" controls>
                    <source src="{{ url_for('.static', filename='car.mp4') }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video> 
            </div>
        </div>
    </body>
</html>

<script>

var side = "none";
var pattern = "none";

let visual = document.getElementById("visual");
let trigger = document.getElementById("simulation-trigger");
let display = document.getElementById("simulation-status");

let instructions = {
    "0,50": ["none", "none"],
    "51,54": ["far", "left"],
    "55,58": ["near", "left"],
    "59,77": ["very_near", "left"],
    "78,90": ["none", "none"],
};

visual.ontimeupdate = () => {
    // During the video playing
    let time = Math.round(visual.currentTime);
    for (const range of Object.keys(instructions)) {
        const frags = range.split(",");
        let start = frags[0];
        let end = frags[1];
        if (time >= start && time <= end) {
            pattern = instructions[range][0];
            side = instructions[range][1];
            break;
        }
    }
};

function printer() {
    console.log(pattern + " on " + side);

    if (side != "none") {
        // Build fake form data
        let formData = new FormData();
        formData.append('pattern', pattern);

        // Start buliding new request
        var xhttp = new XMLHttpRequest();

        // Determine side
        if (side == "left") {
            xhttp.open("POST", "{{ url_for('lhs_control') }}", true);
        } else if (side == "right") {
            xhttp.open("POST", "{{ url_for('rhs_control') }}", true);
        }

        // Send request
        xhttp.send(formData);
    }

    setTimeout(printer, 500);
}
printer()


</script>
